<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>আলোচনা - ফিজারিফ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&display=swap');
        body { font-family: 'Hind Siliguri', sans-serif; }
        .bubble { max-width: 85%; padding: 8px 12px; border-radius: 15px; position: relative; }
        .bubble-other { background-color: #f0f2f5; border-bottom-left-radius: 2px; }
        .dark .bubble-other { background-color: #202c33; color: #e9edef; }
        .bubble-admin { background-color: #dcf8c6; border-bottom-left-radius: 2px; }
        .dark .bubble-admin { background-color: #005c4b; color: #e9edef; }
        .bubble-me { background-color: #e7f3ff; border-bottom-right-radius: 2px; }
        .dark .bubble-me { background-color: #0b4a7d; color: #ffffff; }
        #post-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; align-items: center; justify-content: center; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-[#0b141a] text-gray-900 dark:text-gray-100 min-h-screen">

<div class="max-w-xl mx-auto bg-white dark:bg-[#0b141a] min-h-screen shadow-lg flex flex-col">
    <!-- Header -->
    <div class="sticky top-0 z-10 bg-white dark:bg-[#202c33] border-b dark:border-gray-700 p-4 flex justify-between items-center">
        <h1 class="text-lg font-bold">আলোচনা</h1>
        <div id="auth-ui">
            <button onclick="googleLogin()" id="login-btn" class="text-sm bg-blue-500 text-white px-4 py-1 rounded-full font-bold">লগইন</button>
            <div id="user-ui" class="hidden flex items-center gap-2">
                <span id="user-name" class="text-xs font-bold"></span>
                <button onclick="handleLogout()" class="text-[10px] text-red-500 font-bold">লগআউট</button>
            </div>
        </div>
    </div>

    <!-- Messages -->
    <div id="chat-box" class="flex-1 p-4 space-y-4"></div>

    <!-- FAB -->
    <button onclick="openModal()" class="fixed bottom-6 right-6 w-14 h-14 bg-blue-500 text-white rounded-full shadow-xl flex items-center justify-center text-3xl">+</button>
</div>

<!-- Simple Modal -->
<div id="post-modal" onclick="if(event.target==this) closeModal()">
    <div class="bg-white dark:bg-[#202c33] w-full max-w-sm m-4 p-4 rounded-xl shadow-2xl">
        <textarea id="msg-input" placeholder="আপনার বার্তা..." class="w-full h-32 bg-transparent outline-none resize-none" maxlength="140"></textarea>
        <div class="flex justify-between items-center mt-4 border-t pt-3 dark:border-gray-700">
            <span id="char-count" class="text-xs text-gray-400">০/১৪০</span>
            <button id="send-btn" onclick="postMessage()" class="bg-blue-500 text-white px-6 py-1 rounded-full font-bold">পাঠান</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, orderBy, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB_xkcJ87-E4jkYIDT2dBxOFJHUQvZxbU8",
        authDomain: "myblogcomments-22808.firebaseapp.com",
        projectId: "myblogcomments-22808",
        storageBucket: "myblogcomments-22808.firebasestorage.app",
        messagingSenderId: "1067155293144",
        appId: "1:1067155293144:web:8f10b016462b52d36628ad"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const commentsCol = collection(db, 'blog_comments', 'pages', 'main_chat');

    const ADMIN = 'phys.arif@gmail.com';
    let user = null;

    onAuthStateChanged(auth, u => {
        user = u;
        const isAuth = u && !u.isAnonymous;
        document.getElementById('login-btn').classList.toggle('hidden', isAuth);
        document.getElementById('user-ui').classList.toggle('hidden', !isAuth);
        if(isAuth) document.getElementById('user-name').textContent = u.email === ADMIN ? 'অ্যাডমিন' : u.displayName;
        load();
    });

    window.googleLogin = () => signInWithPopup(auth, provider);
    window.handleLogout = () => signOut(auth);
    window.openModal = () => document.getElementById('post-modal').style.display = 'flex';
    window.closeModal = () => document.getElementById('post-modal').style.display = 'none';

    document.getElementById('msg-input').oninput = e => {
        document.getElementById('char-count').textContent = `${e.target.value.length}/১৪০`;
    };

    function load() {
        onSnapshot(query(commentsCol, orderBy('at', 'desc')), snap => {
            const chatBox = document.getElementById('chat-box');
            chatBox.innerHTML = '';
            snap.forEach(d => {
                const data = d.data();
                const isMe = user && data.uid === user.uid;
                const isAdminMsg = data.email === ADMIN;
                
                const div = document.createElement('div');
                div.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'}`;
                div.innerHTML = `
                    <span class="text-[9px] font-bold text-gray-500 mb-0.5 px-1">${isAdminMsg ? 'অ্যাডমিন' : data.name}</span>
                    <div class="bubble ${isMe ? 'bubble-me' : (isAdminMsg ? 'bubble-admin' : 'bubble-other')}">
                        <p class="text-[15px]">${DOMPurify.sanitize(data.msg)}</p>
                        <div class="flex items-center justify-end gap-2 mt-1 opacity-50 text-[9px]">
                            <span>${formatTime(data.at)}</span>
                            ${user?.email === ADMIN ? `<button onclick="delMsg('${d.id}')" class="text-red-500">×</button>` : ''}
                        </div>
                    </div>
                `;
                chatBox.appendChild(div);
            });
        });
    }

    window.postMessage = async () => {
        const input = document.getElementById('msg-input');
        if(!user || user.isAnonymous || !input.value.trim()) return;
        const btn = document.getElementById('send-btn');
        btn.disabled = true;
        try {
            await addDoc(commentsCol, {
                name: user.displayName, email: user.email, uid: user.uid,
                msg: input.value.trim(), at: serverTimestamp()
            });
            input.value = '';
            closeModal();
        } catch(e) {}
        btn.disabled = false;
    };

    window.delMsg = id => confirm('মুছবেন?') && deleteDoc(doc(db, 'blog_comments', 'pages', 'main_chat', id));

    function formatTime(ts) {
        if(!ts) return '...';
        const d = new Date(ts.seconds * 1000);
        return d.toLocaleTimeString('bn-BD', {hour:'2-digit', minute:'2-digit'});
    }

    signInAnonymously(auth);
</script>
</body>
</html>

