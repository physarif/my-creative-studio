<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>আলোচনা - নিশ ব্লগিং ও কমিউনিটি</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Hind Siliguri', sans-serif; background-color: #f0f2f5; }
        .dark { background-color: #18191a; color: #e4e6eb; }
        .post-card { background: white; border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); transition: all 0.2s; }
        .dark .post-card { background: #242526; box-shadow: none; border: 1px solid #3e4042; }
        .post-card:hover { transform: translateY(-2px); }
        .nav-glass { backdrop-filter: blur(10px); background: rgba(255,255,255,0.8); }
        .dark .nav-glass { background: rgba(36,37,38,0.8); }
        .btn-primary { background-color: #0084ff; color: white; transition: background 0.3s; }
        .btn-primary:hover { background-color: #0073e6; }
        
        /* Modal Animation */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-content { width: 100%; max-width: 600px; background: white; border-radius: 16px; overflow: hidden; animation: zoomIn 0.3s ease-out; }
        .dark .modal-content { background: #242526; color: white; }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="pb-20">

<!-- Navigation -->
<nav class="sticky top-0 z-50 nav-glass border-b border-gray-200 dark:border-gray-800">
    <div class="max-w-5xl mx-auto px-4 h-14 flex items-center justify-between">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-bold text-blue-600 tracking-tight">আলোচনা.</h1>
            <div class="hidden md:flex gap-4 text-sm font-medium text-gray-600 dark:text-gray-400">
                <a href="#" class="hover:text-blue-500">হোম</a>
                <a href="#" class="hover:text-blue-500">ট্রেন্ডিং</a>
                <a href="#" class="hover:text-blue-500">ক্যাটাগরি</a>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <button id="theme-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                <svg id="moon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
            <div id="auth-ui">
                <button onclick="login()" class="px-4 py-1.5 text-sm font-bold btn-primary rounded-full">লগইন</button>
            </div>
        </div>
    </div>
</nav>

<main class="max-w-5xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
    <!-- Left Sidebar -->
    <aside class="hidden lg:block lg:col-span-3 space-y-4">
        <div class="post-card p-4">
            <h3 class="font-bold text-sm text-gray-400 uppercase tracking-widest mb-3">টপ ক্যাটাগরি</h3>
            <div class="space-y-2">
                <button onclick="filterPosts('All')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 font-medium">সব আলোচনা</button>
                <button onclick="filterPosts('প্রযুক্তি')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 font-medium">প্রযুক্তি</button>
                <button onclick="filterPosts('বিজ্ঞান')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 font-medium">বিজ্ঞান</button>
                <button onclick="filterPosts('সাহিত্য')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 font-medium">সাহিত্য</button>
            </div>
        </div>
    </aside>

    <!-- Feed -->
    <section class="lg:col-span-6 space-y-4">
        <!-- New Post Prompt -->
        <div id="create-prompt" class="post-card p-4 flex gap-3 items-center hidden">
            <img id="user-pfp" class="w-10 h-10 rounded-full bg-gray-200">
            <button onclick="openModal()" class="flex-1 text-left bg-gray-100 dark:bg-gray-800 px-4 py-2.5 rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                নতুন একটি টপিক শুরু করুন...
            </button>
        </div>

        <div id="feed-container" class="space-y-4">
            <!-- Posts will be loaded here -->
            <div class="text-center py-20 text-gray-400">লোডিং...</div>
        </div>
    </section>

    <!-- Right Sidebar -->
    <aside class="hidden lg:block lg:col-span-3">
        <div class="post-card p-4 sticky top-20">
            <h3 class="font-bold text-sm text-gray-400 uppercase tracking-widest mb-3">সক্রিয় ইউজার</h3>
            <div id="active-users" class="space-y-3">
                <!-- User list -->
            </div>
        </div>
    </aside>
</main>

<!-- Floating Action Button for Mobile -->
<button onclick="openModal()" class="lg:hidden fixed bottom-6 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-lg flex items-center justify-center z-40">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"></path></svg>
</button>

<!-- Post Modal -->
<div id="post-modal" class="modal-overlay" onclick="if(event.target === this) closeModal()">
    <div class="modal-content">
        <div class="p-4 border-b dark:border-gray-800 flex justify-between items-center">
            <h2 class="font-bold text-lg">নতুন আলোচনা</h2>
            <button onclick="closeModal()" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div class="p-4 space-y-4">
            <select id="post-category" class="w-full p-2.5 rounded-lg border dark:bg-gray-800 dark:border-gray-700 outline-none focus:ring-2 ring-blue-500">
                <option value="সাধারণ">ক্যাটাগরি বেছে নিন</option>
                <option value="প্রযুক্তি">প্রযুক্তি</option>
                <option value="বিজ্ঞান">বিজ্ঞান</option>
                <option value="সাহিত্য">সাহিত্য</option>
            </select>
            <textarea id="post-msg" placeholder="আপনার আলোচনার বিষয়বস্তু লিখুন..." class="w-full h-40 p-3 rounded-lg border dark:bg-gray-800 dark:border-gray-700 outline-none focus:ring-2 ring-blue-500 resize-none"></textarea>
            <div class="flex justify-end">
                <button onclick="savePost()" id="publish-btn" class="px-8 py-2 btn-primary rounded-full font-bold">পাবলিশ করুন</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    // Firebase configuration (You should ideally use your own keys here)
    const firebaseConfig = {
        apiKey: "AIzaSyB_xkcJ87-E4jkYIDT2dBxOFJHUQvZxbU8",
        authDomain: "myblogcomments-22808.firebaseapp.com",
        projectId: "myblogcomments-22808",
        storageBucket: "myblogcomments-22808.firebasestorage.app",
        messagingSenderId: "1067155293144",
        appId: "1:1067155293144:web:8f10b016462b52d36628ad"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const forumCol = collection(db, 'blog_comments', 'pages', 'community_v1');

    let currentUser = null;
    let currentFilter = 'All';

    // Auth State
    onAuthStateChanged(auth, (user) => {
        currentUser = user;
        const authUi = document.getElementById('auth-ui');
        const prompt = document.getElementById('create-prompt');
        
        if (user) {
            authUi.innerHTML = `<img src="${user.photoURL}" onclick="logout()" class="w-9 h-9 rounded-full border border-blue-500 cursor-pointer" title="Logout">`;
            prompt.classList.remove('hidden');
            document.getElementById('user-pfp').src = user.photoURL;
        } else {
            authUi.innerHTML = `<button onclick="login()" class="px-4 py-1.5 text-sm font-bold btn-primary rounded-full">লগইন</button>`;
            prompt.classList.add('hidden');
        }
    });

    window.login = () => signInWithPopup(auth, provider);
    window.logout = () => signOut(auth);

    // Load Posts
    const loadPosts = () => {
        const q = query(forumCol, orderBy('at', 'desc'));
        onSnapshot(q, (snapshot) => {
            const data = [];
            snapshot.forEach(doc => data.push({ id: doc.id, ...doc.data() }));
            renderPosts(data);
            renderUsers(data);
        });
    };

    const renderPosts = (posts) => {
        const container = document.getElementById('feed-container');
        let filtered = currentFilter === 'All' ? posts : posts.filter(p => p.cat === currentFilter);
        
        container.innerHTML = filtered.map(p => `
            <div class="post-card p-5">
                <div class="flex gap-3 mb-4">
                    <img src="${p.photoURL}" class="w-10 h-10 rounded-full">
                    <div>
                        <h4 class="font-bold text-sm leading-tight">${p.name}</h4>
                        <p class="text-[11px] text-gray-500 font-bold uppercase tracking-wide">${p.cat || 'সাধারণ'} • ${formatTime(p.at)}</p>
                    </div>
                </div>
                <div class="text-[15px] leading-relaxed mb-4">
                    ${DOMPurify.sanitize(marked.parse(p.msg))}
                </div>
                <div class="flex gap-6 border-t dark:border-gray-800 pt-3">
                    <button class="flex items-center gap-1.5 text-gray-500 hover:text-blue-500 text-xs font-bold transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                        আলোচনা যোগ করুন
                    </button>
                    <button class="flex items-center gap-1.5 text-gray-500 hover:text-green-500 text-xs font-bold transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
                        শেয়ার
                    </button>
                </div>
            </div>
        `).join('');
    };

    const renderUsers = (posts) => {
        const userMap = new Map();
        posts.forEach(p => userMap.set(p.userId, { name: p.name, photo: p.photoURL }));
        const userList = Array.from(userMap.values()).slice(0, 5);
        document.getElementById('active-users').innerHTML = userList.map(u => `
            <div class="flex items-center gap-2">
                <img src="${u.photo}" class="w-6 h-6 rounded-full">
                <span class="text-sm font-medium truncate">${u.name}</span>
            </div>
        `).join('');
    };

    window.savePost = async () => {
        const msg = document.getElementById('post-msg').value.trim();
        const cat = document.getElementById('post-category').value;
        if (!msg || !currentUser) return;

        const btn = document.getElementById('publish-btn');
        btn.disabled = true;
        btn.innerText = "পাবলিশ হচ্ছে...";

        try {
            await addDoc(forumCol, {
                name: currentUser.displayName,
                msg: msg,
                cat: cat,
                photoURL: currentUser.photoURL,
                userId: currentUser.uid,
                at: serverTimestamp()
            });
            document.getElementById('post-msg').value = '';
            closeModal();
        } catch (e) {
            console.error(e);
        } finally {
            btn.disabled = false;
            btn.innerText = "পাবলিশ করুন";
        }
    };

    window.filterPosts = (cat) => {
        currentFilter = cat;
        loadPosts();
    };

    // UI Helpers
    window.openModal = () => document.getElementById('post-modal').style.display = 'flex';
    window.closeModal = () => document.getElementById('post-modal').style.display = 'none';

    document.getElementById('theme-btn').onclick = () => {
        document.body.classList.toggle('dark');
        const isDark = document.body.classList.contains('dark');
        document.getElementById('moon').innerHTML = isDark 
            ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 9H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>'
            : '<path d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>';
    };

    const toBN = (n) => n.toString().replace(/\d/g, d => "০১২৩৪৫৬৭৮৯"[d]);
    function formatTime(ts) {
        if(!ts) return 'এখন';
        const s = Math.floor((new Date() - new Date(ts.seconds * 1000))/1000);
        if(s < 60) return toBN(s) + ' সে. আগে';
        if(s < 3600) return toBN(Math.floor(s/60)) + ' মি. আগে';
        if(s < 86400) return toBN(Math.floor(s/3600)) + ' ঘ. আগে';
        return new Date(ts.seconds*1000).toLocaleDateString('bn-BD', {day:'numeric', month:'short'});
    }

    loadPosts();
</script>
</body>
</html>

